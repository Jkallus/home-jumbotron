# Compiler and linker configuration
CXX := g++
LD := $(CXX)

# Directories
SRCDIR := src
BINDIR := bin
INCDIR := include
CPPZMQ_INCDIR := 3rdparty/cppzmq
SPDLOG_INCDIR := 3rdparty/spdlog/include
RGB_INCDIR := 3rdparty/rpi-rgb-led-matrix/include
RGB_LIBDIR := 3rdparty/rpi-rgb-led-matrix/lib

# Compiler flags
CXXFLAGS := -Wall -std=c++11 -MMD -MP -I$(INCDIR) -I$(CPPZMQ_INCDIR) -I$(SPDLOG_INCDIR) \
            $(shell GraphicsMagick++-config --cxxflags --cppflags) -I/usr/local/include

# Linker flags
LDFLAGS := -lrt -lm -lpthread -lzmq -lpigpio \
           $(shell GraphicsMagick++-config --ldflags --libs)
LDFLAGS_GPIO_TEST := -lrt -lm -lpthread -lpigpio

# RGB Matrix library configuration
RGB_LIBRARY_NAME := rgbmatrix
RGB_LDFLAGS := -L$(RGB_LIBDIR) -l$(RGB_LIBRARY_NAME)
RGB_MATRIX_LIB_MAKEFILE := $(RGB_LIBDIR)/Makefile
RGB_MATRIX_LIB_TARGET := $(RGB_LIBDIR)/lib$(RGB_LIBRARY_NAME).a

# Source files
SRCS_IMAGE_DISPLAY := $(SRCDIR)/main.cpp
SRCS_GPIO_TEST := $(SRCDIR)/gpio_test.cpp

# Object files
OBJS_IMAGE_DISPLAY := $(SRCS_IMAGE_DISPLAY:.cpp=.o)
OBJS_GPIO_TEST := $(SRCS_GPIO_TEST:.cpp=.o)

# Targets
TARGET_IMAGE_DISPLAY := $(BINDIR)/image-display
TARGET_GPIO_TEST := $(BINDIR)/gpio-test

# Default target
all: $(TARGET_IMAGE_DISPLAY) $(TARGET_GPIO_TEST)

# Target rules
$(TARGET_IMAGE_DISPLAY): $(OBJS_IMAGE_DISPLAY) $(RGB_MATRIX_LIB_TARGET)
	mkdir -p $(BINDIR)
	$(LD) $(OBJS_IMAGE_DISPLAY) -o $@ $(LDFLAGS) $(RGB_LDFLAGS)

$(TARGET_GPIO_TEST): $(OBJS_GPIO_TEST)
	mkdir -p $(BINDIR)
	$(LD) $(OBJS_GPIO_TEST) -o $@ $(LDFLAGS_GPIO_TEST)

$(RGB_MATRIX_LIB_TARGET): $(RGB_MATRIX_LIB_MAKEFILE)
	$(MAKE) -C $(dir $(RGB_MATRIX_LIB_MAKEFILE))

# Pattern rule for object files
$(SRCDIR)/%.o: $(SRCDIR)/%.cpp
	$(CXX) -c $< -o $@ $(CXXFLAGS) -I$(RGB_INCDIR)

# Include the dependency files generated by GCC
-include $(OBJS_IMAGE_DISPLAY:.o=.d)
-include $(OBJS_GPIO_TEST:.o=.d)

# Clean target
clean:
	rm -f $(OBJS_IMAGE_DISPLAY) $(OBJS_GPIO_TEST)
	rm -f $(OBJS_IMAGE_DISPLAY:.o=.d) $(OBJS_GPIO_TEST:.o=.d)
	rm -f $(TARGET_IMAGE_DISPLAY) $(TARGET_GPIO_TEST)
	$(MAKE) -C $(RGB_LIBDIR) clean